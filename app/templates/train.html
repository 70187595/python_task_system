{% extends "base.html" %}

{% block title %}–û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ - Python Task System{% endblock %}

{% block extra_css %}
<style>
    .training-card {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .parameter-input {
        margin-bottom: 15px;
    }
    
    .training-log {
        background-color: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Consolas', 'Monaco', monospace;
        padding: 15px;
        border-radius: 4px;
        height: 400px;
        overflow-y: auto;
        font-size: 13px;
        line-height: 1.5;
    }
    
    .training-log .log-info {
        color: #4ec9b0;
    }
    
    .training-log .log-success {
        color: #4fc3f7;
    }
    
    .training-log .log-warning {
        color: #ff9800;
    }
    
    .training-log .log-error {
        color: #f44336;
    }
    
    .training-log .log-epoch {
        color: #dcdcaa;
        font-weight: bold;
    }
    
    .progress-container {
        margin: 20px 0;
    }
    
    .model-info {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        border-left: 4px solid #007bff;
    }
    
    .loss-chart {
        width: 100%;
        height: 300px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: white;
    }
    
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    
    .metric-card {
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        text-align: center;
    }
    
    .metric-value {
        font-size: 2em;
        font-weight: bold;
        color: #007bff;
    }
    
    .metric-label {
        color: #666;
        font-size: 0.9em;
        margin-top: 5px;
    }
    
    .btn-train {
        min-width: 150px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="bi bi-cpu"></i> –û–±—É—á–µ–Ω–∏–µ –Ω–µ–π—Ä–æ–Ω–Ω–æ–π —Å–µ—Ç–∏</h1>
            <p class="text-muted">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞</p>
        </div>
    </div>
    
    <div class="row">
        <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—É—á–µ–Ω–∏—è -->
        <div class="col-lg-4">
            <div class="card training-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—É—á–µ–Ω–∏—è</h5>
                </div>
                <div class="card-body">
                    <form id="training-form">
                        <!-- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ -->
                        <div class="parameter-input">
                            <label for="hidden_size" class="form-label">
                                –†–∞–∑–º–µ—Ä —Å–∫—Ä—ã—Ç–æ–≥–æ —Å–ª–æ—è
                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" 
                                   title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–π—Ä–æ–Ω–æ–≤ –≤ —Å–∫—Ä—ã—Ç–æ–º —Å–ª–æ–µ (4-16)"></i>
                            </label>
                            <input type="number" class="form-control" id="hidden_size" 
                                   value="8" min="4" max="16" required>
                            <small class="text-muted">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 8 (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ)</small>
                        </div>
                        
                        <!-- Learning Rate -->
                        <div class="parameter-input">
                            <label for="learning_rate" class="form-label">
                                Learning Rate (Œ±)
                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" 
                                   title="–°–∫–æ—Ä–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è (0.001 - 0.1)"></i>
                            </label>
                            <input type="number" class="form-control" id="learning_rate" 
                                   value="0.05" min="0.001" max="0.1" step="0.001" required>
                            <small class="text-muted">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: 0.05</small>
                        </div>
                        
                        <!-- Epochs -->
                        <div class="parameter-input">
                            <label for="epochs" class="form-label">
                                –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ø–æ—Ö
                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" 
                                   title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Ö–æ–¥–æ–≤ –ø–æ –¥–∞—Ç–∞—Å–µ—Ç—É"></i>
                            </label>
                            <input type="number" class="form-control" id="epochs" 
                                   value="2000" min="100" max="5000" step="100" required>
                            <small class="text-muted">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 2000</small>
                        </div>
                        
                        <!-- Activation Function -->
                        <div class="parameter-input">
                            <label for="activation" class="form-label">
                                –§—É–Ω–∫—Ü–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
                            </label>
                            <select class="form-select" id="activation">
                                <option value="sigmoid">Sigmoid</option>
                                <option value="relu">ReLU</option>
                            </select>
                        </div>
                        
                        <!-- Dropout -->
                        <div class="parameter-input">
                            <label for="dropout_rate" class="form-label">
                                Dropout Rate
                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" 
                                   title="–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –Ω–µ–π—Ä–æ–Ω–æ–≤ (0 - 0.5)"></i>
                            </label>
                            <input type="number" class="form-control" id="dropout_rate" 
                                   value="0.0" min="0.0" max="0.5" step="0.1">
                            <small class="text-muted">0.0 = –±–µ–∑ dropout (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</small>
                        </div>
                        
                        <hr>
                        
                        <!-- –ö–Ω–æ–ø–∫–∏ -->
                        <button type="submit" class="btn btn-primary btn-train w-100 mb-2" id="btn-start-training">
                            <i class="bi bi-play-fill"></i> –ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ
                        </button>
                        
                        <button type="button" class="btn btn-danger btn-train w-100 mb-2" 
                                id="btn-stop-training" style="display: none;">
                            <i class="bi bi-stop-fill"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        </button>
                        
                        <button type="button" class="btn btn-success btn-train w-100" 
                                id="btn-save-model" disabled>
                            <i class="bi bi-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–æ–¥–µ–ª—å
                        </button>
                    </form>
                    
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞—Ç–∞—Å–µ—Ç–µ -->
                    <div class="model-info mt-4">
                        <h6><i class="bi bi-database"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞—Ç–∞—Å–µ—Ç–µ</h6>
                        <p class="mb-1"><strong>–ü—Ä–∏–º–µ—Ä–æ–≤:</strong> <span id="dataset-size">210</span></p>
                        <p class="mb-1"><strong>–ü—Ä–∏–∑–Ω–∞–∫–æ–≤:</strong> 10</p>
                        <p class="mb-0"><strong>–í—ã—Ö–æ–¥–æ–≤:</strong> 3</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ü—Ä–æ—Ü–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div class="col-lg-8">
            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è -->
            <div class="card training-card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üìä –ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è</h5>
                </div>
                <div class="card-body">
                    <div class="progress-container">
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="training-progress" role="progressbar" 
                                 style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                0%
                            </div>
                        </div>
                        <p class="text-center mt-2 mb-0" id="progress-text">
                            –û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –æ–±—É—á–µ–Ω–∏—è...
                        </p>
                    </div>
                    
                    <!-- –ú–µ—Ç—Ä–∏–∫–∏ -->
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-value" id="current-epoch">0</div>
                            <div class="metric-label">–¢–µ–∫—É—â–∞—è —ç–ø–æ—Ö–∞</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="current-loss">-</div>
                            <div class="metric-label">–¢–µ–∫—É—â–∞—è –æ—à–∏–±–∫–∞</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="best-loss">-</div>
                            <div class="metric-label">–õ—É—á—à–∞—è –æ—à–∏–±–∫–∞</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="time-elapsed">00:00</div>
                            <div class="metric-label">–í—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è</div>
                        </div>
                    </div>
                    
                    <!-- –ì—Ä–∞—Ñ–∏–∫ loss -->
                    <div class="mt-4">
                        <h6>–ì—Ä–∞—Ñ–∏–∫ –æ—à–∏–±–∫–∏ –ø–æ —ç–ø–æ—Ö–∞–º</h6>
                        <canvas id="loss-chart" class="loss-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- –õ–æ–≥ –æ–±—É—á–µ–Ω–∏—è -->
            <div class="card training-card mt-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">üìù –õ–æ–≥ –æ–±—É—á–µ–Ω–∏—è</h5>
                </div>
                <div class="card-body p-0">
                    <div class="training-log" id="training-log">
                        <div class="log-info">[–°–ò–°–¢–ï–ú–ê] –û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –æ–±—É—á–µ–Ω–∏—è...</div>
                        <div class="log-info">[–ò–ù–§–û] –î–∞—Ç–∞—Å–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω: 210 –ø—Ä–∏–º–µ—Ä–æ–≤</div>
                        <div class="log-info">[–ò–ù–§–û] –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: 10 ‚Üí ? ‚Üí 3</div>
                        <div class="log-info">[–ò–ù–§–û] –ì–æ—Ç–æ–≤–æ –∫ –æ–±—É—á–µ–Ω–∏—é</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<script>
    let trainingChart = null;
    let trainingStartTime = null;
    let trainingInterval = null;
    let isTraining = false;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
    function initChart() {
        const ctx = document.getElementById('loss-chart').getContext('2d');
        trainingChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Training Loss',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Loss (MSE)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '–≠–ø–æ—Ö–∞'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ª–æ–≥
    function addLog(message, type = 'info') {
        const log = document.getElementById('training-log');
        const timestamp = new Date().toLocaleTimeString();
        const logClass = `log-${type}`;
        
        const logEntry = document.createElement('div');
        logEntry.className = logClass;
        logEntry.textContent = `[${timestamp}] ${message}`;
        
        log.appendChild(logEntry);
        log.scrollTop = log.scrollHeight;
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    function updateProgress(current, total) {
        const percentage = Math.round((current / total) * 100);
        const progressBar = document.getElementById('training-progress');
        progressBar.style.width = percentage + '%';
        progressBar.setAttribute('aria-valuenow', percentage);
        progressBar.textContent = percentage + '%';
        
        document.getElementById('progress-text').textContent = 
            `–≠–ø–æ—Ö–∞ ${current} –∏–∑ ${total} (${percentage}%)`;
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞
    function updateTimer() {
        if (!trainingStartTime) return;
        
        const elapsed = Math.floor((Date.now() - trainingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        
        document.getElementById('time-elapsed').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –æ–±—É—á–µ–Ω–∏—è
    document.getElementById('training-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (isTraining) return;
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        const params = {
            hidden_size: parseInt(document.getElementById('hidden_size').value),
            learning_rate: parseFloat(document.getElementById('learning_rate').value),
            epochs: parseInt(document.getElementById('epochs').value),
            activation: document.getElementById('activation').value,
            dropout_rate: parseFloat(document.getElementById('dropout_rate').value)
        };
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (params.hidden_size < 4 || params.hidden_size > 16) {
            alert('–†–∞–∑–º–µ—Ä —Å–∫—Ä—ã—Ç–æ–≥–æ —Å–ª–æ—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 4 –¥–æ 16');
            return;
        }
        
        if (params.learning_rate < 0.001 || params.learning_rate > 0.1) {
            alert('Learning rate –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 0.001 –¥–æ 0.1');
            return;
        }
        
        // –ù–∞—á–∞–ª–æ –æ–±—É—á–µ–Ω–∏—è
        isTraining = true;
        document.getElementById('btn-start-training').style.display = 'none';
        document.getElementById('btn-stop-training').style.display = 'block';
        document.getElementById('btn-save-model').disabled = true;
        
        // –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–∞
        document.getElementById('training-log').innerHTML = '';
        addLog('–ù–∞—á–∞–ª–æ –æ–±—É—á–µ–Ω–∏—è...', 'success');
        addLog(`–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: 10 ‚Üí ${params.hidden_size} ‚Üí 3`, 'info');
        addLog(`Learning Rate: ${params.learning_rate}`, 'info');
        addLog(`–≠–ø–æ—Ö–∏: ${params.epochs}`, 'info');
        addLog(`–ê–∫—Ç–∏–≤–∞—Ü–∏—è: ${params.activation}`, 'info');
        
        // –°–±—Ä–æ—Å –≥—Ä–∞—Ñ–∏–∫–∞
        trainingChart.data.labels = [];
        trainingChart.data.datasets[0].data = [];
        trainingChart.update();
        
        // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
        trainingStartTime = Date.now();
        trainingInterval = setInterval(updateTimer, 1000);
        
        try {
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            const response = await fetch('/api/train-model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(params)
            });
            
            const result = await response.json();
            
            if (result.success) {
                addLog('–û–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!', 'success');
                addLog(`–§–∏–Ω–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞: ${result.final_loss.toFixed(6)}`, 'success');
                addLog(`–£–ª—É—á—à–µ–Ω–∏–µ: ${result.improvement.toFixed(2)}%`, 'success');
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
                result.history.epochs.forEach((epoch, index) => {
                    trainingChart.data.labels.push(epoch);
                    trainingChart.data.datasets[0].data.push(result.history.loss[index]);
                });
                trainingChart.update();
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
                document.getElementById('current-epoch').textContent = params.epochs;
                document.getElementById('current-loss').textContent = result.final_loss.toFixed(6);
                document.getElementById('best-loss').textContent = result.final_loss.toFixed(6);
                
                updateProgress(params.epochs, params.epochs);
                
                document.getElementById('btn-save-model').disabled = false;
                
            } else {
                addLog(`–û—à–∏–±–∫–∞: ${result.error}`, 'error');
            }
            
        } catch (error) {
            addLog(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
        } finally {
            isTraining = false;
            clearInterval(trainingInterval);
            document.getElementById('btn-start-training').style.display = 'block';
            document.getElementById('btn-stop-training').style.display = 'none';
        }
    });
    
    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—É—á–µ–Ω–∏—è
    document.getElementById('btn-stop-training').addEventListener('click', function() {
        if (isTraining) {
            addLog('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—É—á–µ–Ω–∏—è...', 'warning');
            // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        }
    });
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
    document.getElementById('btn-save-model').addEventListener('click', async function() {
        try {
            const response = await fetch('/api/save-model', {
                method: 'POST'
            });
            
            const result = await response.json();
            
            if (result.success) {
                addLog('–ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
                alert('–ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
            } else {
                addLog(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${result.error}`, 'error');
            }
        } catch (error) {
            addLog(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
        }
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        initChart();
        
        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
{% endblock %}

