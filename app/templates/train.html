{% extends "base.html" %}

{% block title %}–û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ - Python Task System{% endblock %}

{% block extra_css %}
<style>
    .training-card {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .parameter-input {
        margin-bottom: 15px;
    }
    
    .training-log {
        background-color: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Consolas', 'Monaco', monospace;
        padding: 15px;
        border-radius: 4px;
        height: 400px;
        overflow-y: auto;
        font-size: 13px;
        line-height: 1.5;
    }
    
    .training-log .log-info {
        color: #4ec9b0;
    }
    
    .training-log .log-success {
        color: #4fc3f7;
    }
    
    .training-log .log-warning {
        color: #ff9800;
    }
    
    .training-log .log-error {
        color: #f44336;
    }
    
    .training-log .log-epoch {
        color: #dcdcaa;
        font-weight: bold;
    }
    
    .progress-container {
        margin: 20px 0;
    }
    
    .model-info {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        border-left: 4px solid #007bff;
    }
    
    .loss-chart {
        width: 100%;
        height: 300px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: white;
    }
    
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    
    .metric-card {
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        text-align: center;
    }
    
    .metric-value {
        font-size: 2em;
        font-weight: bold;
        color: #007bff;
    }
    
    .metric-label {
        color: #666;
        font-size: 0.9em;
        margin-top: 5px;
    }
    
    .btn-train {
        min-width: 150px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="bi bi-cpu"></i> –û–±—É—á–µ–Ω–∏–µ –Ω–µ–π—Ä–æ–Ω–Ω–æ–π —Å–µ—Ç–∏</h1>
            <p class="text-muted">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞</p>
        </div>
    </div>
    
    <div class="row">
        <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—É—á–µ–Ω–∏—è -->
        <div class="col-lg-4">
            <div class="card training-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—É—á–µ–Ω–∏—è</h5>
                </div>
                <div class="card-body">
                    <form id="training-form">
                        <!-- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ -->
                        <div class="parameter-input">
                            <label for="hidden_size" class="form-label">
                                –†–∞–∑–º–µ—Ä —Å–∫—Ä—ã—Ç–æ–≥–æ —Å–ª–æ—è
                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" 
                                   title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–π—Ä–æ–Ω–æ–≤ –≤ —Å–∫—Ä—ã—Ç–æ–º —Å–ª–æ–µ (4-16)"></i>
                            </label>
                            <input type="number" class="form-control" id="hidden_size" 
                                   value="8" min="4" max="16" required>
                            <small class="text-muted">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 8 (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ)</small>
                        </div>
                        
                        <!-- Learning Rate -->
                        <div class="parameter-input">
                            <label for="learning_rate" class="form-label">
                                Learning Rate (Œ±)
                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" 
                                   title="–°–∫–æ—Ä–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è (0.001 - 0.1)"></i>
                            </label>
                            <input type="number" class="form-control" id="learning_rate" 
                                   value="0.05" min="0.001" max="0.1" step="0.001" required>
                            <small class="text-muted">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: 0.05</small>
                        </div>
                        
                        <!-- Epochs -->
                        <div class="parameter-input">
                            <label for="epochs" class="form-label">
                                –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ø–æ—Ö
                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" 
                                   title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Ö–æ–¥–æ–≤ –ø–æ –¥–∞—Ç–∞—Å–µ—Ç—É"></i>
                            </label>
                            <input type="number" class="form-control" id="epochs" 
                                   value="2000" min="100" max="5000" step="100" required>
                            <small class="text-muted">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 2000</small>
                        </div>
                        
                        <!-- Activation Function -->
                        <div class="parameter-input">
                            <label for="activation" class="form-label">
                                –§—É–Ω–∫—Ü–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
                            </label>
                            <select class="form-select" id="activation">
                                <option value="sigmoid">Sigmoid</option>
                                <option value="relu">ReLU</option>
                            </select>
                        </div>
                        
                        <!-- Dropout -->
                        <div class="parameter-input">
                            <label for="dropout_rate" class="form-label">
                                Dropout Rate
                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" 
                                   title="–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –Ω–µ–π—Ä–æ–Ω–æ–≤ (0 - 0.5)"></i>
                            </label>
                            <input type="number" class="form-control" id="dropout_rate" 
                                   value="0.0" min="0.0" max="0.5" step="0.1">
                            <small class="text-muted">0.0 = –±–µ–∑ dropout (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</small>
                        </div>
                        
                        <hr>
                        
                        <!-- –ö–Ω–æ–ø–∫–∏ -->
                        <button type="submit" class="btn btn-primary btn-train w-100 mb-2" id="btn-start-training">
                            <i class="bi bi-play-fill"></i> –ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ
                        </button>
                        
                        <button type="button" class="btn btn-danger btn-train w-100 mb-2" 
                                id="btn-stop-training" style="display: none;">
                            <i class="bi bi-stop-fill"></i> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                        </button>
                        
                        <button type="button" class="btn btn-success btn-train w-100" 
                                id="btn-save-model" disabled>
                            <i class="bi bi-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–æ–¥–µ–ª—å
                        </button>
                    </form>
                    
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞—Ç–∞—Å–µ—Ç–µ -->
                    <div class="model-info mt-4">
                        <h6><i class="bi bi-database"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞—Ç–∞—Å–µ—Ç–µ</h6>
                        <p class="mb-1"><strong>–ü—Ä–∏–º–µ—Ä–æ–≤:</strong> <span id="dataset-size">210</span></p>
                        <p class="mb-1"><strong>–ü—Ä–∏–∑–Ω–∞–∫–æ–≤:</strong> 10</p>
                        <p class="mb-0"><strong>–í—ã—Ö–æ–¥–æ–≤:</strong> 3</p>
                    </div>
                </div>
            </div>
            
            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª—è–º–∏ -->
            <div class="card training-card mt-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">üíæ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª—è–º–∏</h5>
                </div>
                <div class="card-body">
                    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                    <div class="d-grid gap-2 mb-3">
                        <button type="button" class="btn btn-outline-primary" 
                                data-bs-toggle="modal" data-bs-target="#loadModelModal">
                            <i class="bi bi-folder-open"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å
                        </button>
                        <button type="button" class="btn btn-outline-success" 
                                data-bs-toggle="modal" data-bs-target="#importModelModal">
                            <i class="bi bi-upload"></i> –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å
                        </button>
                        <button type="button" class="btn btn-outline-info" 
                                data-bs-toggle="modal" data-bs-target="#modelsListModal">
                            <i class="bi bi-list-ul"></i> –°–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π
                        </button>
                    </div>
                    
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–π –º–æ–¥–µ–ª–∏ -->
                    <div class="model-info">
                        <h6><i class="bi bi-cpu"></i> –¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å</h6>
                        <p class="mb-1" id="current-model-name"><strong>–ò–º—è:</strong> neural_network.json</p>
                        <p class="mb-0" id="current-model-params"><strong>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:</strong> 10‚Üí8‚Üí3</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ü—Ä–æ—Ü–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div class="col-lg-8">
            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è -->
            <div class="card training-card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üìä –ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è</h5>
                </div>
                <div class="card-body">
                    <div class="progress-container">
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="training-progress" role="progressbar" 
                                 style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                0%
                            </div>
                        </div>
                        <p class="text-center mt-2 mb-0" id="progress-text">
                            –û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –æ–±—É—á–µ–Ω–∏—è...
                        </p>
                    </div>
                    
                    <!-- –ú–µ—Ç—Ä–∏–∫–∏ -->
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-value" id="current-epoch">0</div>
                            <div class="metric-label">–¢–µ–∫—É—â–∞—è —ç–ø–æ—Ö–∞</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="current-loss">-</div>
                            <div class="metric-label">–¢–µ–∫—É—â–∞—è –æ—à–∏–±–∫–∞</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="best-loss">-</div>
                            <div class="metric-label">–õ—É—á—à–∞—è –æ—à–∏–±–∫–∞</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="time-elapsed">00:00</div>
                            <div class="metric-label">–í—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è</div>
                        </div>
                    </div>
                    
                    <!-- –ì—Ä–∞—Ñ–∏–∫ loss -->
                    <div class="mt-4">
                        <h6>–ì—Ä–∞—Ñ–∏–∫ –æ—à–∏–±–∫–∏ –ø–æ —ç–ø–æ—Ö–∞–º</h6>
                        <canvas id="loss-chart" class="loss-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- –õ–æ–≥ –æ–±—É—á–µ–Ω–∏—è -->
            <div class="card training-card mt-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">üìù –õ–æ–≥ –æ–±—É—á–µ–Ω–∏—è</h5>
                </div>
                <div class="card-body p-0">
                    <div class="training-log" id="training-log">
                        <div class="log-info">[–°–ò–°–¢–ï–ú–ê] –û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –æ–±—É—á–µ–Ω–∏—è...</div>
                        <div class="log-info">[–ò–ù–§–û] –î–∞—Ç–∞—Å–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω: 210 –ø—Ä–∏–º–µ—Ä–æ–≤</div>
                        <div class="log-info">[–ò–ù–§–û] –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: 10 ‚Üí ? ‚Üí 3</div>
                        <div class="log-info">[–ò–ù–§–û] –ì–æ—Ç–æ–≤–æ –∫ –æ–±—É—á–µ–Ω–∏—é</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ -->
<div class="modal fade" id="loadModelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="model-select" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å:</label>
                    <select class="form-select" id="model-select">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π...</option>
                    </select>
                </div>
                <div id="model-details" class="model-info" style="display: none;">
                    <h6>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥–µ–ª–∏</h6>
                    <p class="mb-1"><strong>–†–∞–∑–º–µ—Ä:</strong> <span id="model-size"></span></p>
                    <p class="mb-1"><strong>–ò–∑–º–µ–Ω–µ–Ω–æ:</strong> <span id="model-modified"></span></p>
                    <p class="mb-0"><strong>–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:</strong> <span id="model-arch"></span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="btn-load-model">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –ò–º–ø–æ—Ä—Ç –º–æ–¥–µ–ª–∏ -->
<div class="modal fade" id="importModelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="model-file" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ JSON —Ñ–∞–π–ª –º–æ–¥–µ–ª–∏:</label>
                    <input type="file" class="form-control" id="model-file" accept=".json">
                </div>
                <div class="mb-3">
                    <label for="model-custom-name" class="form-label">–ò–º—è –º–æ–¥–µ–ª–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                    <input type="text" class="form-control" id="model-custom-name" 
                           placeholder="model_custom.json">
                    <small class="text-muted">–ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∏–º—è —Ñ–∞–π–ª–∞</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-success" id="btn-import-model">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –°–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π -->
<div class="modal fade" id="modelsListModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–°–ø–∏—Å–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="models-list-container">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button type="button" class="btn btn-primary" onclick="refreshModelsList()">
                    <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Chart.js –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<script>
    let trainingChart = null;
    let trainingStartTime = null;
    let trainingInterval = null;
    let isTraining = false;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
    function initChart() {
        const ctx = document.getElementById('loss-chart').getContext('2d');
        trainingChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Training Loss',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Loss (MSE)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '–≠–ø–æ—Ö–∞'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ª–æ–≥
    function addLog(message, type = 'info') {
        const log = document.getElementById('training-log');
        const timestamp = new Date().toLocaleTimeString();
        const logClass = `log-${type}`;
        
        const logEntry = document.createElement('div');
        logEntry.className = logClass;
        logEntry.textContent = `[${timestamp}] ${message}`;
        
        log.appendChild(logEntry);
        log.scrollTop = log.scrollHeight;
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    function updateProgress(current, total) {
        const percentage = Math.round((current / total) * 100);
        const progressBar = document.getElementById('training-progress');
        progressBar.style.width = percentage + '%';
        progressBar.setAttribute('aria-valuenow', percentage);
        progressBar.textContent = percentage + '%';
        
        document.getElementById('progress-text').textContent = 
            `–≠–ø–æ—Ö–∞ ${current} –∏–∑ ${total} (${percentage}%)`;
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞
    function updateTimer() {
        if (!trainingStartTime) return;
        
        const elapsed = Math.floor((Date.now() - trainingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        
        document.getElementById('time-elapsed').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –æ–±—É—á–µ–Ω–∏—è
    document.getElementById('training-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (isTraining) return;
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        const params = {
            hidden_size: parseInt(document.getElementById('hidden_size').value),
            learning_rate: parseFloat(document.getElementById('learning_rate').value),
            epochs: parseInt(document.getElementById('epochs').value),
            activation: document.getElementById('activation').value,
            dropout_rate: parseFloat(document.getElementById('dropout_rate').value)
        };
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (params.hidden_size < 4 || params.hidden_size > 16) {
            alert('–†–∞–∑–º–µ—Ä —Å–∫—Ä—ã—Ç–æ–≥–æ —Å–ª–æ—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 4 –¥–æ 16');
            return;
        }
        
        if (params.learning_rate < 0.001 || params.learning_rate > 0.1) {
            alert('Learning rate –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 0.001 –¥–æ 0.1');
            return;
        }
        
        // –ù–∞—á–∞–ª–æ –æ–±—É—á–µ–Ω–∏—è
        isTraining = true;
        document.getElementById('btn-start-training').style.display = 'none';
        document.getElementById('btn-stop-training').style.display = 'block';
        document.getElementById('btn-save-model').disabled = true;
        
        // –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–∞
        document.getElementById('training-log').innerHTML = '';
        addLog('–ù–∞—á–∞–ª–æ –æ–±—É—á–µ–Ω–∏—è...', 'success');
        addLog(`–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: 10 ‚Üí ${params.hidden_size} ‚Üí 3`, 'info');
        addLog(`Learning Rate: ${params.learning_rate}`, 'info');
        addLog(`–≠–ø–æ—Ö–∏: ${params.epochs}`, 'info');
        addLog(`–ê–∫—Ç–∏–≤–∞—Ü–∏—è: ${params.activation}`, 'info');
        
        // –°–±—Ä–æ—Å –≥—Ä–∞—Ñ–∏–∫–∞
        trainingChart.data.labels = [];
        trainingChart.data.datasets[0].data = [];
        trainingChart.update();
        
        // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
        trainingStartTime = Date.now();
        trainingInterval = setInterval(updateTimer, 1000);
        
        try {
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            const response = await fetch('/api/train-model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(params)
            });
            
            const result = await response.json();
            
            if (result.success) {
                addLog('–û–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!', 'success');
                addLog(`–§–∏–Ω–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞: ${result.final_loss.toFixed(6)}`, 'success');
                addLog(`–£–ª—É—á—à–µ–Ω–∏–µ: ${result.improvement.toFixed(2)}%`, 'success');
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
                result.history.epochs.forEach((epoch, index) => {
                    trainingChart.data.labels.push(epoch);
                    trainingChart.data.datasets[0].data.push(result.history.loss[index]);
                });
                trainingChart.update();
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
                document.getElementById('current-epoch').textContent = params.epochs;
                document.getElementById('current-loss').textContent = result.final_loss.toFixed(6);
                document.getElementById('best-loss').textContent = result.final_loss.toFixed(6);
                
                updateProgress(params.epochs, params.epochs);
                
                document.getElementById('btn-save-model').disabled = false;
                
            } else {
                addLog(`–û—à–∏–±–∫–∞: ${result.error}`, 'error');
            }
            
        } catch (error) {
            addLog(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
        } finally {
            isTraining = false;
            clearInterval(trainingInterval);
            document.getElementById('btn-start-training').style.display = 'block';
            document.getElementById('btn-stop-training').style.display = 'none';
        }
    });
    
    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—É—á–µ–Ω–∏—è
    document.getElementById('btn-stop-training').addEventListener('click', function() {
        if (isTraining) {
            addLog('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—É—á–µ–Ω–∏—è...', 'warning');
            // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        }
    });
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
    document.getElementById('btn-save-model').addEventListener('click', async function() {
        try {
            const response = await fetch('/api/save-model', {
                method: 'POST'
            });
            
            const result = await response.json();
            
            if (result.success) {
                addLog('–ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
                alert('–ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
            } else {
                addLog(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${result.error}`, 'error');
            }
        } catch (error) {
            addLog(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, 'error');
        }
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        initChart();
        
        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        document.getElementById('loadModelModal').addEventListener('shown.bs.modal', loadModelsList);
        document.getElementById('modelsListModal').addEventListener('shown.bs.modal', refreshModelsList);
    });
    
    // ============================================================
    // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ú–û–î–ï–õ–Ø–ú–ò
    // ============================================================
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π –¥–ª—è –≤—ã–±–æ—Ä–∞
    async function loadModelsList() {
        const select = document.getElementById('model-select');
        select.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
        
        try {
            const response = await fetch('/api/list-models');
            const result = await response.json();
            
            if (result.success) {
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å...</option>';
                
                result.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = model.name;
                    option.dataset.size = model.size;
                    option.dataset.modified = model.modified;
                    option.dataset.params = JSON.stringify(model.parameters);
                    select.appendChild(option);
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞
                select.onchange = function() {
                    if (this.value) {
                        const option = this.selectedOptions[0];
                        const params = JSON.parse(option.dataset.params || '{}');
                        
                        document.getElementById('model-size').textContent = 
                            (option.dataset.size / 1024).toFixed(2) + ' KB';
                        document.getElementById('model-modified').textContent = option.dataset.modified;
                        document.getElementById('model-arch').textContent = 
                            params ? `${params.input_size}‚Üí${params.hidden_size}‚Üí${params.output_size}` : 'N/A';
                        document.getElementById('model-details').style.display = 'block';
                    } else {
                        document.getElementById('model-details').style.display = 'none';
                    }
                };
            }
        } catch (error) {
            select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π:', error);
        }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
    document.getElementById('btn-load-model').addEventListener('click', async function() {
        const modelName = document.getElementById('model-select').value;
        
        if (!modelName) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
            return;
        }
        
        try {
            const response = await fetch('/api/load-model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ model_name: modelName })
            });
            
            const result = await response.json();
            
            if (result.success) {
                const params = result.parameters;
                document.getElementById('current-model-name').innerHTML = 
                    `<strong>–ò–º—è:</strong> ${modelName}`;
                document.getElementById('current-model-params').innerHTML = 
                    `<strong>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:</strong> ${params.input_size}‚Üí${params.hidden_size}‚Üí${params.output_size} (${params.activation})`;
                
                addLog(`–ú–æ–¥–µ–ª—å ${modelName} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞`, 'success');
                alert(result.message);
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                bootstrap.Modal.getInstance(document.getElementById('loadModelModal')).hide();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + result.error);
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏: ' + error.message);
        }
    });
    
    // –ò–º–ø–æ—Ä—Ç –º–æ–¥–µ–ª–∏
    document.getElementById('btn-import-model').addEventListener('click', async function() {
        const fileInput = document.getElementById('model-file');
        const customName = document.getElementById('model-custom-name').value;
        
        if (!fileInput.files || fileInput.files.length === 0) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞');
            return;
        }
        
        const formData = new FormData();
        formData.append('model_file', fileInput.files[0]);
        if (customName) {
            formData.append('model_name', customName);
        }
        
        try {
            const response = await fetch('/api/import-model', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                addLog(`–ú–æ–¥–µ–ª—å ${result.model_name} –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞`, 'success');
                alert(result.message);
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                fileInput.value = '';
                document.getElementById('model-custom-name').value = '';
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                bootstrap.Modal.getInstance(document.getElementById('importModelModal')).hide();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + result.error);
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥–µ–ª–∏: ' + error.message);
        }
    });
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π
    async function refreshModelsList() {
        const container = document.getElementById('models-list-container');
        container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>';
        
        try {
            const response = await fetch('/api/list-models');
            const result = await response.json();
            
            if (result.success) {
                if (result.models.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π</p>';
                    return;
                }
                
                let html = '<div class="list-group">';
                
                result.models.forEach(model => {
                    const params = model.parameters;
                    const arch = params ? `${params.input_size}‚Üí${params.hidden_size}‚Üí${params.output_size}` : 'N/A';
                    const size = (model.size / 1024).toFixed(2);
                    
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${model.name}</h6>
                                <small>${model.modified}</small>
                            </div>
                            <p class="mb-1">
                                <strong>–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:</strong> ${arch} | 
                                <strong>–†–∞–∑–º–µ—Ä:</strong> ${size} KB
                            </p>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary" 
                                        onclick="loadModelFromList('${model.name}')">
                                    <i class="bi bi-download"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å
                                </button>
                                <button type="button" class="btn btn-outline-danger" 
                                        onclick="deleteModel('${model.name}')"
                                        ${['neural_network.json', 'model_final.json'].includes(model.name) ? 'disabled' : ''}>
                                    <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            }
        } catch (error) {
            container.innerHTML = '<p class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π</p>';
            console.error('–û—à–∏–±–∫–∞:', error);
        }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ –∏–∑ —Å–ø–∏—Å–∫–∞
    async function loadModelFromList(modelName) {
        if (!confirm(`–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å ${modelName}?`)) {
            return;
        }
        
        try {
            const response = await fetch('/api/load-model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ model_name: modelName })
            });
            
            const result = await response.json();
            
            if (result.success) {
                const params = result.parameters;
                document.getElementById('current-model-name').innerHTML = 
                    `<strong>–ò–º—è:</strong> ${modelName}`;
                document.getElementById('current-model-params').innerHTML = 
                    `<strong>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:</strong> ${params.input_size}‚Üí${params.hidden_size}‚Üí${params.output_size} (${params.activation})`;
                
                addLog(`–ú–æ–¥–µ–ª—å ${modelName} –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ —Å–ø–∏—Å–∫–∞`, 'success');
                alert(result.message);
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                bootstrap.Modal.getInstance(document.getElementById('modelsListModal')).hide();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + result.error);
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏: ' + error.message);
        }
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
    async function deleteModel(modelName) {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –º–æ–¥–µ–ª—å ${modelName}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`)) {
            return;
        }
        
        try {
            const response = await fetch('/api/delete-model', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ model_name: modelName })
            });
            
            const result = await response.json();
            
            if (result.success) {
                addLog(`–ú–æ–¥–µ–ª—å ${modelName} —É–¥–∞–ª–µ–Ω–∞`, 'warning');
                alert(result.message);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                refreshModelsList();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + result.error);
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–æ–¥–µ–ª–∏: ' + error.message);
        }
    }
</script>
{% endblock %}

