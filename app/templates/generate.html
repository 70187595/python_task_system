{% extends "base.html" %}

{% block title %}–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–¥–∞–Ω–∏–π - –°–∏—Å—Ç–µ–º–∞ –∑–∞–¥–∞–Ω–∏–π Python{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0">üéØ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É—á–µ–±–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</h3>
            </div>
            <div class="card-body">
                <!-- –§–æ—Ä–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
                <form id="generateForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="category" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∑–∞–¥–∞–Ω–∏—è</label>
                                <select class="form-select" id="category" name="category" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                    {% for category in categories %}
                                        <option value="{{ category }}">{{ category|title }}</option>
                                    {% endfor %}
                                    <option value="custom">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="difficulty" class="form-label">–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏</label>
                                <select class="form-select" id="difficulty" name="difficulty" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ–∂–Ω–æ—Å—Ç—å</option>
                                    {% for difficulty in difficulties %}
                                        <option value="{{ difficulty }}">{{ difficulty|title }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- –ü–æ–ª—è –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è -->
                    <div id="customFields" style="display: none;">
                        <div class="mb-3">
                            <label for="title" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</label>
                            <input type="text" class="form-control" id="title" name="title" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è">
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</label>
                            <textarea class="form-control" id="description" name="description" rows="3" placeholder="–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="testCases" class="form-label">–¢–µ—Å—Ç–æ–≤—ã–µ —Å–ª—É—á–∞–∏ (JSON)</label>
                            <textarea class="form-control" id="testCases" name="test_cases" rows="4" placeholder='[{"input": "–≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ", "expected": "–æ–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç"}]'></textarea>
                            <div class="form-text">–í–≤–µ–¥–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–ª—É—á–∞–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON</div>
                        </div>
                    </div>

                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-magic me-2"></i>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -->
        <div id="generatedTask" style="display: none;" class="card mt-4">
            <div class="card-header">
                <h4 class="mb-0">üìù –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ</h4>
            </div>
            <div class="card-body">
                <div id="taskContent">
                    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–¥–∞–Ω–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∑–¥–µ—Å—å -->
                </div>
                
                <div class="mt-3">
                    <button type="button" class="btn btn-success me-2" onclick="solveTask()">
                        <i class="fas fa-code me-2"></i>–†–µ—à–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="generateNew()">
                        <i class="fas fa-refresh me-2"></i>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ–µ
                    </button>
                </div>
            </div>
        </div>

        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
        <div id="loading" style="display: none;" class="text-center mt-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p class="mt-2">–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–∞–¥–∞–Ω–∏–µ...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentTask = null;

    // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–ª—è –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
    document.getElementById('category').addEventListener('change', function() {
        const customFields = document.getElementById('customFields');
        if (this.value === 'custom') {
            customFields.style.display = 'block';
            // –°–¥–µ–ª–∞—Ç—å –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏
            document.getElementById('title').required = true;
            document.getElementById('description').required = true;
        } else {
            customFields.style.display = 'none';
            // –£–±—Ä–∞—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            document.getElementById('title').required = false;
            document.getElementById('description').required = false;
        }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    document.getElementById('generateForm').addEventListener('submit', function(e) {
        e.preventDefault();
        generateTask();
    });

    function generateTask() {
        const form = document.getElementById('generateForm');
        const formData = new FormData(form);
        
        const data = {
            category: formData.get('category'),
            difficulty: formData.get('difficulty')
        };

        // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
        if (data.category === 'custom') {
            data.title = formData.get('title');
            data.description = formData.get('description');
            
            try {
                data.test_cases = JSON.parse(formData.get('test_cases') || '[]');
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–ª—É—á–∞–µ–≤');
                return;
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
        document.getElementById('loading').style.display = 'block';
        document.getElementById('generatedTask').style.display = 'none';

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å
        fetch('/api/generate-task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('loading').style.display = 'none';
            
            if (data.success) {
                currentTask = data.task;
                displayTask(data.task);
            } else {
                alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞–Ω–∏—è: ' + data.error);
            }
        })
        .catch(error => {
            document.getElementById('loading').style.display = 'none';
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞–Ω–∏—è');
        });
    }

    function displayTask(task) {
        const taskContent = document.getElementById('taskContent');
        
        taskContent.innerHTML = `
            <div class="mb-3">
                <h5>${task.title}</h5>
                <span class="badge bg-${getDifficultyColor(task.difficulty)}">${task.difficulty}</span>
                <span class="badge bg-secondary ms-2">${task.category}</span>
            </div>
            
            <div class="mb-3">
                <h6>–û–ø–∏—Å–∞–Ω–∏–µ:</h6>
                <p class="text-muted">${task.description}</p>
            </div>
            
            <div class="mb-3">
                <h6>–¢–µ—Å—Ç–æ–≤—ã–µ —Å–ª—É—á–∞–∏:</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</th>
                                <th>–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${task.test_cases.map(test => `
                                <tr>
                                    <td><code>${test.input}</code></td>
                                    <td><code>${test.expected}</code></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="mb-3">
                <h6>–ü–æ–¥—Å–∫–∞–∑–∫–∏:</h6>
                <ul class="list-unstyled">
                    ${task.hints.map(hint => `<li><i class="fas fa-lightbulb text-warning me-2"></i>${hint}</li>`).join('')}
                </ul>
            </div>
            
            <div class="mb-3">
                <h6>–®–∞–±–ª–æ–Ω —Ä–µ—à–µ–Ω–∏—è:</h6>
                <pre class="bg-light p-3 rounded"><code>${task.solution_template}</code></pre>
            </div>
        `;
        
        document.getElementById('generatedTask').style.display = 'block';
    }

    function getDifficultyColor(difficulty) {
        switch(difficulty) {
            case 'easy': return 'success';
            case 'medium': return 'warning';
            case 'hard': return 'danger';
            default: return 'secondary';
        }
    }

    function solveTask() {
        if (currentTask) {
            window.location.href = `/solve/${currentTask.id}`;
        }
    }

    function generateNew() {
        document.getElementById('generatedTask').style.display = 'none';
        document.getElementById('generateForm').reset();
        document.getElementById('customFields').style.display = 'none';
        currentTask = null;
    }
</script>
{% endblock %}
