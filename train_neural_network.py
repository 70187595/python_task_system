"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –Ω–µ–π—Ä–æ–Ω–Ω–æ–π —Å–µ—Ç–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
"""

import sys
import os
import json
import numpy as np

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from app.models.neural_network import SimpleNeuralNetwork
from app.utils.code_analyzer import CodeAnalyzer

def load_training_data():
    """
    –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—É—á–∞—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON-—Ñ–∞–π–ª–∞
    
    –ß–∏—Ç–∞–µ—Ç —Ñ–∞–π–ª training_data.json —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∫–æ–¥–∞ Python,
    —Å–æ–¥–µ—Ä–∂–∞—â–∏–º–∏ –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –∏ —Ü–µ–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞.
    
    Returns:
        list: –°–ø–∏—Å–æ–∫ –ø—Ä–∏–º–µ—Ä–æ–≤ –æ–±—É—á–∞—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
        
    Raises:
        FileNotFoundError: –ï—Å–ª–∏ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    """
    try:
        with open('data/training_data/training_data.json', 'r', encoding='utf-8') as f:
            data = json.load(f)
        print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(data)} –ø—Ä–∏–º–µ—Ä–æ–≤ –æ–±—É—á–∞—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö")
        return data
    except FileNotFoundError:
        print("‚ùå –§–∞–π–ª —Å –æ–±—É—á–∞—é—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        print("üîß –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞: python data/training_data/generate_training_data.py")
        return None

def prepare_training_data(data):
    """
    –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –Ω–µ–π—Ä–æ–Ω–Ω–æ–π —Å–µ—Ç–∏
    
    –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç numpy –º–∞—Å—Å–∏–≤–æ–≤.
    –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–∏ –ø—É—Ç–µ–º –¥–µ–ª–µ–Ω–∏—è –Ω–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:
    - lines_of_code –¥–µ–ª–∏—Ç—Å—è –Ω–∞ 100 (–æ–∂–∏–¥–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä 0-100 —Å—Ç—Ä–æ–∫)
    - functions_count –¥–µ–ª–∏—Ç—Å—è –Ω–∞ 10 (–æ–±—ã—á–Ω–æ 0-10 —Ñ—É–Ω–∫—Ü–∏–π)
    - nested_levels –¥–µ–ª–∏—Ç—Å—è –Ω–∞ 5 (–≥–ª—É–±–∏–Ω–∞ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ 0-5)
    –ò —Ç.–¥. –¥–ª—è –≤—Å–µ—Ö 10 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤.
    
    Args:
        data: –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –ø–æ–ª—è–º–∏ 'features' –∏ 'target'
        
    Returns:
        tuple: (X, y) –≥–¥–µ X - –º–∞—Å—Å–∏–≤ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ (N√ó10), y - –º–∞—Å—Å–∏–≤ —Ü–µ–ª–µ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π (N√ó3)
    """
    X = []  # –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ø—Ä–∏–∑–Ω–∞–∫–∏)
    y = []  # –¶–µ–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
    
    for item in data:
        features = item['features']
        target = item['target']
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø—Ä–∏–∑–Ω–∞–∫–∏ –≤ –≤–µ–∫—Ç–æ—Ä
        feature_vector = [
            features['lines_of_code'] / 100.0,
            features['functions_count'] / 10.0,
            features['complexity'],
            features['nested_levels'] / 5.0,
            features['variable_names_length'] / 20.0,
            features['comments_ratio'],
            features['imports_count'] / 10.0,
            features['class_count'] / 5.0,
            features['error_handling'],
            features['test_coverage']
        ]
        
        X.append(feature_vector)
        y.append(target)
    
    return np.array(X), np.array(y)

def train_network():
    """
    –û–±—É—á–µ–Ω–∏–µ –Ω–µ–π—Ä–æ–Ω–Ω–æ–π —Å–µ—Ç–∏ –Ω–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–±—É—á–µ–Ω–∏—è:
    1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –æ–±—É—á–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
    2. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫–∏
    3. –°–æ–∑–¥–∞–µ—Ç –Ω–µ–π—Ä–æ–Ω–Ω—É—é —Å–µ—Ç—å —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π 10‚Üí8‚Üí3
    4. –û–±—É—á–∞–µ—Ç —Å–µ—Ç—å –Ω–∞ 2000 —ç–ø–æ—Ö–∞—Ö
    5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–æ–¥–µ–ª—å –∏ –∏—Å—Ç–æ—Ä–∏—é –æ–±—É—á–µ–Ω–∏—è
    6. –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–∞—Ö
    
    Returns:
        SimpleNeuralNetwork: –û–±—É—á–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
    """
    print("üß† –û–±—É—á–µ–Ω–∏–µ –Ω–µ–π—Ä–æ–Ω–Ω–æ–π —Å–µ—Ç–∏...")
    print("=" * 50)
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    data = load_training_data()
    if data is None:
        return None
    
    # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    X, y = prepare_training_data(data)
    
    print(f"üìä –†–∞–∑–º–µ—Ä –æ–±—É—á–∞—é—â–µ–π –≤—ã–±–æ—Ä–∫–∏: {X.shape[0]} –ø—Ä–∏–º–µ—Ä–æ–≤")
    print(f"üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤: {X.shape[1]}")
    print(f"üìä –†–∞–∑–º–µ—Ä –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Å–ª–æ—è: {y.shape[1]}")
    
    # –°–æ–∑–¥–∞–µ–º –Ω–µ–π—Ä–æ–Ω–Ω—É—é —Å–µ—Ç—å
    network = SimpleNeuralNetwork(
        input_size=X.shape[1],
        hidden_size=8,  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–∫—Ä—ã—Ç—ã–π —Å–ª–æ–π
        output_size=y.shape[1]
    )
    
    print(f"üîß –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Ç–∏:")
    print(f"   –í—Ö–æ–¥–Ω–æ–π —Å–ª–æ–π: {network.input_size} –Ω–µ–π—Ä–æ–Ω–æ–≤")
    print(f"   –°–∫—Ä—ã—Ç—ã–π —Å–ª–æ–π: {network.hidden_size} –Ω–µ–π—Ä–æ–Ω–æ–≤")
    print(f"   –í—ã—Ö–æ–¥–Ω–æ–π —Å–ª–æ–π: {network.output_size} –Ω–µ–π—Ä–æ–Ω–æ–≤")
    
    # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
    training_data = [(X[i:i+1], y[i:i+1]) for i in range(len(X))]
    
    print("\nüöÄ –ù–∞—á–∏–Ω–∞–µ–º –æ–±—É—á–µ–Ω–∏–µ...")
    
    # –û–±—É—á–∞–µ–º —Å–µ—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
    training_history = network.train(training_data, epochs=2000)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –æ–±—É—á–µ–Ω–∏—è
    os.makedirs('data/models', exist_ok=True)
    history_path = 'data/models/training_history.json'
    with open(history_path, 'w', encoding='utf-8') as f:
        json.dump(training_history, f, ensure_ascii=False, indent=2)
    
    print(f"\nüìä –ò—Å—Ç–æ—Ä–∏—è –æ–±—É—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤: {history_path}")
    print(f"   –ù–∞—á–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞: {training_history['loss'][0]:.4f}")
    print(f"   –ö–æ–Ω–µ—á–Ω–∞—è –æ—à–∏–±–∫–∞: {training_history['loss'][-1]:.4f}")
    print(f"   –£–ª—É—á—à–µ–Ω–∏–µ: {(1 - training_history['loss'][-1]/training_history['loss'][0])*100:.1f}%")
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–∏–º–µ—Ä–∞—Ö
    print("\nüß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—É—á–µ–Ω–Ω–æ–π —Å–µ—Ç–∏:")
    print("-" * 50)
    
    test_indices = [0, len(data)//4, len(data)//2, 3*len(data)//4, len(data)-1]
    
    for i, idx in enumerate(test_indices):
        test_features = X[idx:idx+1]
        test_target = y[idx]
        prediction = network.predict(test_features)
        
        print(f"–¢–µ—Å—Ç {i+1}:")
        print(f"  –û–∂–∏–¥–∞–µ–º–æ–µ: [{test_target[0]:.2f}, {test_target[1]:.2f}, {test_target[2]:.2f}]")
        print(f"  –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ: [{prediction[0][0]:.2f}, {prediction[0][1]:.2f}, {prediction[0][2]:.2f}]")
        print(f"  –û—à–∏–±–∫–∞: {np.mean(np.abs(test_target - prediction[0])):.3f}")
        print()
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—É—á–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å
    os.makedirs('data/models', exist_ok=True)
    network.save_model('data/models/neural_network.json')
    
    print("‚úÖ –û–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
    print("üíæ –ú–æ–¥–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤: data/models/neural_network.json")
    
    return network

def test_with_real_code():
    """
    –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—É—á–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–∞—Ö –∫–æ–¥–∞
    
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –µ–µ –Ω–∞ 4 –ø—Ä–∏–º–µ—Ä–∞—Ö –∫–æ–¥–∞
    —Ä–∞–∑–Ω–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞:
    - –û—Ç–ª–∏—á–Ω—ã–π –∫–æ–¥: —Ö–æ—Ä–æ—à–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    - –•–æ—Ä–æ—à–∏–π –∫–æ–¥: –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º, –Ω–æ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π
    - –ü–ª–æ—Ö–æ–π –∫–æ–¥: —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ–æ–ø—Ç–∏–º–∞–ª–µ–Ω –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
    - –£–∂–∞—Å–Ω—ã–π –∫–æ–¥: –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –∏–∑–±—ã—Ç–æ—á–Ω–∞—è –ª–æ–≥–∏–∫–∞
    
    –í—ã–≤–æ–¥–∏—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –º–æ–¥–µ–ª–∏ –ø–æ —Ç—Ä–µ–º –º–µ—Ç—Ä–∏–∫–∞–º:
    - –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å (correctness)
    - –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (efficiency)
    - –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å (readability)
    """
    print("\nüîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º...")
    print("=" * 50)
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—É—á–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å
    network = SimpleNeuralNetwork()
    network.load_model('data/models/neural_network.json')
    
    analyzer = CodeAnalyzer()
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞
    test_codes = [
        {
            "name": "–û—Ç–ª–∏—á–Ω—ã–π –∫–æ–¥",
            "code": """def sort_list(numbers):
    \"\"\"–°–æ—Ä—Ç–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ —á–∏—Å–µ–ª –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é.\"\"\"
    return sorted(numbers)"""
        },
        {
            "name": "–•–æ—Ä–æ—à–∏–π –∫–æ–¥",
            "code": """def fibonacci(n):
    if n <= 1:
        return n
    return fibonacci(n-1) + fibonacci(n-2)"""
        },
        {
            "name": "–ü–ª–æ—Ö–æ–π –∫–æ–¥",
            "code": """def find_max(numbers):
    max = 0
    for i in numbers:
        if i > max:
            max = i
    return max"""
        },
        {
            "name": "–£–∂–∞—Å–Ω—ã–π –∫–æ–¥",
            "code": """def count_words(text):
    a = 0
    b = 0
    c = 0
    for i in text:
        if i == ' ':
            a = a + 1
        b = b + 1
        c = c + 1
    return a + 1"""
        }
    ]
    
    for test_case in test_codes:
        print(f"üìù {test_case['name']}:")
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–¥
        code_features = analyzer.extract_features(test_case['code'])
        
        # –û—Ü–µ–Ω–∏–≤–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ
        quality = network.evaluate_code_quality(code_features)
        
        print(f"  –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å: {quality['correctness']:.2f}")
        print(f"  –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {quality['efficiency']:.2f}")
        print(f"  –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å: {quality['readability']:.2f}")
        print(f"  –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞: {np.mean(list(quality.values())):.2f}")
        print()

def main():
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±—É—á–µ–Ω–∏—è
    
    –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
    1. –ó–∞–ø—É—Å–∫–∞–µ—Ç –æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    2. –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –æ–±—É—á–µ–Ω–∏–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–∞—Ö
    3. –í—ã–≤–æ–¥–∏—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–æ–¥–µ–ª—å
    """
    print("üêç –û–ë–£–ß–ï–ù–ò–ï –ù–ï–ô–†–û–ù–ù–û–ô –°–ï–¢–ò –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê –ö–ê–ß–ï–°–¢–í–ê –ö–û–î–ê")
    print("=" * 60)
    
    # –û–±—É—á–∞–µ–º —Å–µ—Ç—å
    network = train_network()
    
    if network is not None:
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –∫–æ–¥–µ
        test_with_real_code()
        
        print("\nüéâ –û–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!")
        print("üîß –¢–µ–ø–µ—Ä—å –Ω–µ–π—Ä–æ–Ω–Ω–∞—è —Å–µ—Ç—å –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏")
    else:
        print("\n‚ùå –û–±—É—á–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å")

if __name__ == '__main__':
    main()
